<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weather Forecast</title>

  <!-- Leaflet CSS + JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    #map {
      height: 400px;
      width: 90%;
      margin: 20px auto;
      border-radius: 12px;
      z-index: 10;
    }
  </style>

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <div class="language-select">
    <select id="langSelect">
      <option value="en">English</option>
      <option value="ru">Русский</option>
      <option value="hu">Magyar</option>
    </select>
  </div>

  <!-- Weather -->
  <div class="weather-container">
    <div class="main-weather" id="mainWeather">
      <div class="loader">Loading your weather...</div>
    </div>
    <h2 id="forecastTitle" class="forecast-title"></h2>
    <div class="forecast-container" id="forecast"></div>
  </div>

  <!-- WEATHER ANIMATIONS -->
  <div id="animationContainer" class="weather-animation"></div>

  <!-- WEATHER MAP -->
  <h2 style="margin-top:40px;">Weather Map</h2>
  <div id="map"></div>

  <script src="{{ url_for('static', filename='script.js') }}"></script>

  <script>
    const map = L.map('map').setView([47.4979, 19.0402], 6);

    // Base OSM layer
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
    }).addTo(map);

    // --- WIND (Open-Meteo) ---
    const windLayer = L.tileLayer(
      "https://tile.open-meteo.com/v1/wind/{z}/{x}/{y}.png",
      { opacity: 0.55 }
    );

    // --- CLOUDS (Open-Meteo) ---
    const cloudsLayer = L.tileLayer(
      "https://tile.open-meteo.com/v1/clouds/{z}/{x}/{y}.png",
      { opacity: 0.55 }
    );

    // --- RAIN (RainViewer Radar) ---
    let rainLayer;

    fetch("https://api.rainviewer.com/public/weather-maps.json")
      .then(res => res.json())
      .then(data => {
        const last = data.radar.past[data.radar.past.length - 1];
        const path = last.path;

        const urlTemplate = `https://tilecache.rainviewer.com${path}/{size}/{z}/{x}/{y}/2/1_1.png`;

        rainLayer = L.tileLayer(urlTemplate.replace("{size}", "256"), {
          opacity: 0.6,
          tileSize: 256,
        });

        rainLayer.addTo(map); // отображаем сразу
      })
      .catch(err => console.error("RainViewer error:", err));

    // --- Layer Switcher ---
    const overlays = {
      "Rain (RainViewer)": () => rainLayer,
      "Wind (Open-Meteo)": windLayer,
      "Clouds (Open-Meteo)": cloudsLayer
    };

    // Добавим контрол с моментом, когда дождевой слой загрузится
    setTimeout(() => {
      L.control.layers(null, {
        "Rain (RainViewer)": rainLayer,
        "Wind (Open-Meteo)": windLayer,
        "Clouds (Open-Meteo)": cloudsLayer
      }).addTo(map);
    }, 1000);

    // Для перемещения карты извне
    window.moveMapTo = function(lat, lon) {
      map.setView([lat, lon], 9);
    };
  </script>

</body>
</html>
